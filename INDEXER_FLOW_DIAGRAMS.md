# Ocean Node Indexer - Flow Diagrams

Visual representations of current and proposed architectures.

---

## 1. CURRENT ARCHITECTURE - COMPONENT VIEW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          OceanIndexer                                â”‚
â”‚  - Main coordinator in main thread                                   â”‚
â”‚  - Manages worker lifecycle                                          â”‚
â”‚  - Handles job queue (JOBS_QUEUE)                                    â”‚
â”‚  - Manages reindex tasks (INDEXING_QUEUE)                            â”‚
â”‚  - Event emitters (INDEXER_DDO_EVENT_EMITTER)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                      â”‚
           â”‚ Worker Thread      â”‚ Worker Thread        â”‚ Worker Thread
           â†“                    â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CrawlerThread   â”‚  â”‚  CrawlerThread   â”‚  â”‚  CrawlerThread   â”‚
â”‚  Chain: 1        â”‚  â”‚  Chain: 137      â”‚  â”‚  Chain: 8996     â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚  while(true) {   â”‚  â”‚  while(true) {   â”‚  â”‚  while(true) {   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚ Get last  â”‚ â”‚  â”‚    â”‚ Get last  â”‚ â”‚  â”‚    â”‚ Get last  â”‚ â”‚
â”‚    â”‚ indexed   â”‚ â”‚  â”‚    â”‚ indexed   â”‚ â”‚  â”‚    â”‚ indexed   â”‚ â”‚
â”‚    â”‚ block     â”‚ â”‚  â”‚    â”‚ block     â”‚ â”‚  â”‚    â”‚ block     â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†“       â”‚  â”‚          â†“       â”‚  â”‚          â†“       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚Get networkâ”‚ â”‚  â”‚    â”‚Get networkâ”‚ â”‚  â”‚    â”‚Get networkâ”‚ â”‚
â”‚    â”‚ height    â”‚ â”‚  â”‚    â”‚ height    â”‚ â”‚  â”‚    â”‚ height    â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†“       â”‚  â”‚          â†“       â”‚  â”‚          â†“       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚Retrieve   â”‚ â”‚  â”‚    â”‚Retrieve   â”‚ â”‚  â”‚    â”‚Retrieve   â”‚ â”‚
â”‚    â”‚chunk      â”‚ â”‚  â”‚    â”‚chunk      â”‚ â”‚  â”‚    â”‚chunk      â”‚ â”‚
â”‚    â”‚events     â”‚ â”‚  â”‚    â”‚events     â”‚ â”‚  â”‚    â”‚events     â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†“       â”‚  â”‚          â†“       â”‚  â”‚          â†“       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚Process    â”‚ â”‚  â”‚    â”‚Process    â”‚ â”‚  â”‚    â”‚Process    â”‚ â”‚
â”‚    â”‚blocks     â”‚ â”‚  â”‚    â”‚blocks     â”‚ â”‚  â”‚    â”‚blocks     â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†“       â”‚  â”‚          â†“       â”‚  â”‚          â†“       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚Update DB  â”‚ â”‚  â”‚    â”‚Update DB  â”‚ â”‚  â”‚    â”‚Update DB  â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†“       â”‚  â”‚          â†“       â”‚  â”‚          â†“       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚Sleep 30s  â”‚ â”‚  â”‚    â”‚Sleep 30s  â”‚ â”‚  â”‚    â”‚Sleep 30s  â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†“       â”‚  â”‚          â†“       â”‚  â”‚          â†“       â”‚
â”‚  }               â”‚  â”‚  }               â”‚  â”‚  }               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                      â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Database Layer      â”‚
                    â”‚  - DDO Storage        â”‚
                    â”‚  - Order Storage      â”‚
                    â”‚  - Indexer State      â”‚
                    â”‚  - DDO State          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. CURRENT ARCHITECTURE - EVENT PROCESSING FLOW

```
Event Log (from RPC)
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ processChunkLogs(logs, signer, provider, chainId)           â”‚
â”‚                                                              â”‚
â”‚ for each log:                                                â”‚
â”‚   1. findEventByKey(log.topics[0])                          â”‚
â”‚   2. if (METADATA_CREATED/UPDATED/STATE):                    â”‚
â”‚        â”œâ”€â†’ Check allowedValidators                          â”‚
â”‚        â”œâ”€â†’ Get transaction receipt                          â”‚
â”‚        â”œâ”€â†’ Fetch MetadataValidated events                   â”‚
â”‚        â”œâ”€â†’ Validate validators                              â”‚
â”‚        â”‚   â”œâ”€â†’ Check ALLOWED_VALIDATORS list               â”‚
â”‚        â”‚   â””â”€â†’ For each access list:                        â”‚
â”‚        â”‚       â””â”€â†’ For each validator:                      â”‚
â”‚        â”‚           â””â”€â†’ Check balanceOf()                    â”‚
â”‚        â””â”€â†’ If not valid: continue (skip event)              â”‚
â”‚   3. Route to processor                                      â”‚
â”‚   4. Store in storeEvents{}                                  â”‚
â”‚                                                              â”‚
â”‚ return storeEvents                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Processor (processors/*.ts)                            â”‚
â”‚                                                              â”‚
â”‚ MetadataEventProcessor:                                      â”‚
â”‚   â”œâ”€â†’ wasNFTDeployedByOurFactory()                          â”‚
â”‚   â”œâ”€â†’ getEventData() - decode from receipt                  â”‚
â”‚   â”œâ”€â†’ decryptDDO() - 400+ lines                             â”‚
â”‚   â”‚   â”œâ”€â†’ HTTP decryption                                   â”‚
â”‚   â”‚   â”œâ”€â†’ P2P decryption                                    â”‚
â”‚   â”‚   â””â”€â†’ Local decryption                                  â”‚
â”‚   â”œâ”€â†’ Check authorizedPublishers                            â”‚
â”‚   â”œâ”€â†’ Check authorizedPublishersList                        â”‚
â”‚   â”œâ”€â†’ getTokenInfo()                                        â”‚
â”‚   â”œâ”€â†’ getNFTInfo()                                          â”‚
â”‚   â”œâ”€â†’ getPricingStatsForDddo()                              â”‚
â”‚   â”œâ”€â†’ PolicyServer check                                    â”‚
â”‚   â”œâ”€â†’ Purgatory check                                       â”‚
â”‚   â””â”€â†’ createOrUpdateDDO()                                   â”‚
â”‚                                                              â”‚
â”‚ OrderStartedEventProcessor:                                  â”‚
â”‚   â”œâ”€â†’ Decode event                                          â”‚
â”‚   â”œâ”€â†’ Get DDO from database                                 â”‚
â”‚   â”œâ”€â†’ Update stats.orders                                   â”‚
â”‚   â”œâ”€â†’ Create order record                                   â”‚
â”‚   â””â”€â†’ Update DDO                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database Operations                                          â”‚
â”‚   â”œâ”€â†’ ddoDatabase.update()                                  â”‚
â”‚   â”œâ”€â†’ ddoState.update()                                     â”‚
â”‚   â””â”€â†’ orderDatabase.create()                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. PROPOSED ARCHITECTURE - COMPONENT VIEW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IndexerOrchestrator                        â”‚
â”‚  - Single coordinator                                         â”‚
â”‚  - Manages ChainIndexer lifecycle                            â”‚
â”‚  - Health checks                                             â”‚
â”‚  - Metrics aggregation                                       â”‚
â”‚  - Event bus for notifications                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                      â”‚
           â”‚ async              â”‚ async                â”‚ async
           â†“                    â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChainIndexer    â”‚  â”‚  ChainIndexer    â”‚  â”‚  ChainIndexer    â”‚
â”‚  Chain: 1        â”‚  â”‚  Chain: 137      â”‚  â”‚  Chain: 8996     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                      â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BlockScanner  â”‚    â”‚ EventExtractor   â”‚    â”‚ValidationPipelineâ”‚
â”‚               â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚ - RPC client  â”‚    â”‚ - Decode events  â”‚    â”‚ - Chain of       â”‚
â”‚ - Fallback    â”‚    â”‚ - Categorize     â”‚    â”‚   validators     â”‚
â”‚ - Retry       â”‚    â”‚ - Filter         â”‚    â”‚ - Parallel exec  â”‚
â”‚ - Circuit     â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚   breaker     â”‚    â”‚                  â”‚    â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ EventProcessor   â”‚
                    â”‚                  â”‚
                    â”‚ - Route to       â”‚
                    â”‚   handlers       â”‚
                    â”‚ - Transform to   â”‚
                    â”‚   domain models  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  StateManager    â”‚
                    â”‚                  â”‚
                    â”‚ - Repositories   â”‚
                    â”‚ - Transactions   â”‚
                    â”‚ - Batch ops      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Database Layer  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. PROPOSED ARCHITECTURE - EVENT PROCESSING FLOW

```
Raw Event Logs
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. EventExtractor.extractEvents(logs)                â”‚
â”‚                                                      â”‚
â”‚    Parse and categorize events:                     â”‚
â”‚    {                                                 â”‚
â”‚      metadata: [...],                                â”‚
â”‚      orders: [...],                                  â”‚
â”‚      pricing: [...],                                 â”‚
â”‚      unknown: [...]                                  â”‚
â”‚    }                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ValidationPipeline.validate(event)                â”‚
â”‚                                                      â”‚
â”‚    Chain of validators (can run in parallel):       â”‚
â”‚                                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚    â”‚ FactoryValidator     â”‚â†’ Check NFT factory      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚               â†“                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚    â”‚MetadataProofValidatorâ”‚â†’ Check signatures       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚               â†“                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚    â”‚ PublisherValidator   â”‚â†’ Check authorized       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚               â†“                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚    â”‚ AccessListValidator  â”‚â†’ Check access list      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚               â†“                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚    â”‚ PolicyServerValidatorâ”‚â†’ Check policy           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚               â†“                                      â”‚
â”‚    Result: { valid: boolean, errors: [...] }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ (only valid events)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. EventProcessor.process(event)                     â”‚
â”‚                                                      â”‚
â”‚    Route to appropriate handler:                    â”‚
â”‚                                                      â”‚
â”‚    if (MetadataEvent):                               â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚MetadataCreatedHandler  â”‚                     â”‚
â”‚      â”‚  - Decrypt DDO         â”‚                     â”‚
â”‚      â”‚  - Fetch pricing       â”‚                     â”‚
â”‚      â”‚  - Build entity        â”‚                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚               â†“                                      â”‚
â”‚      Domain Entity: DDO                              â”‚
â”‚                                                      â”‚
â”‚    if (OrderEvent):                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚ OrderStartedHandler    â”‚                     â”‚
â”‚      â”‚  - Update order count  â”‚                     â”‚
â”‚      â”‚  - Build entity        â”‚                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚               â†“                                      â”‚
â”‚      Domain Entity: Order                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. StateManager.saveBatch(entities)                  â”‚
â”‚                                                      â”‚
â”‚    transaction {                                     â”‚
â”‚      for each entity:                                â”‚
â”‚        â”œâ”€â†’ ddoRepository.save()                     â”‚
â”‚        â”œâ”€â†’ orderRepository.save()                   â”‚
â”‚        â””â”€â†’ stateRepository.update()                 â”‚
â”‚    }                                                 â”‚
â”‚                                                      â”‚
â”‚    Single database transaction, batched writes       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. EventBus.emit('event.processed', entity)          â”‚
â”‚                                                      â”‚
â”‚    Notify listeners for:                             â”‚
â”‚    - Replication                                     â”‚
â”‚    - Notifications                                   â”‚
â”‚    - Webhooks                                        â”‚
â”‚    - Metrics                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. BLOCK CRAWLING FLOW - CURRENT vs PROPOSED

### CURRENT (with Worker Threads)

```
Main Thread                    Worker Thread (Chain 1)
     â”‚                                â”‚
     â”‚  startThread(chainId)          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
     â”‚                                â”‚ Start infinite loop
     â”‚                                â”‚
     â”‚                                â”œâ†’ getLastIndexedBlock()
     â”‚                                â”‚  (from DB)
     â”‚                                â”‚
     â”‚                                â”œâ†’ getNetworkHeight()
     â”‚                                â”‚  (RPC call)
     â”‚                                â”‚
     â”‚                                â”œâ†’ retrieveChunkEvents()
     â”‚                                â”‚  (RPC call)
     â”‚                                â”‚
     â”‚                                â”œâ†’ processBlocks()
     â”‚                                â”‚  â”œâ†’ processChunkLogs()
     â”‚                                â”‚  â”‚  â”œâ†’ validate
     â”‚                                â”‚  â”‚  â”œâ†’ process
     â”‚                                â”‚  â”‚  â””â†’ store
     â”‚                                â”‚  â”‚
     â”‚                                â”‚  â””â†’ updateLastIndexedBlock()
     â”‚                                â”‚     (DB write)
     â”‚                                â”‚
     â”‚  message: 'METADATA_CREATED'   â”‚
     â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  emit event                    â”‚
     â”‚                                â”‚
     â”‚                                â”œâ†’ sleep(30s)
     â”‚                                â”‚
     â”‚                                â””â†’ loop continues...
     â”‚
     â”‚  stopThread(chainId)           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
     â”‚                                â”‚ set stoppedCrawling = true
     â”‚                                â”‚ exit loop

Issues:
âŒ Complex message passing
âŒ Global state management
âŒ Hard to debug
âŒ Testing requires Worker Thread mocking
```

### PROPOSED (with async/await)

```
IndexerOrchestrator              ChainIndexer (Chain 1)
     â”‚                                â”‚
     â”‚  start()                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
     â”‚                                â”‚ async run() {
     â”‚                                â”‚
     â”‚                                â”œâ†’ progress = await stateManager
     â”‚                                â”‚                .getProgress()
     â”‚                                â”‚
     â”‚                                â”œâ†’ height = await blockScanner
     â”‚                                â”‚              .getLatestBlock()
     â”‚                                â”‚
     â”‚                                â”œâ†’ logs = await blockScanner
     â”‚                                â”‚           .getLogs(from, to)
     â”‚                                â”‚
     â”‚                                â”œâ†’ events = eventExtractor
     â”‚                                â”‚             .extract(logs)
     â”‚                                â”‚
     â”‚                                â”œâ†’ for each event:
     â”‚                                â”‚   result = await pipeline
     â”‚                                â”‚               .validate(event)
     â”‚                                â”‚   if (result.valid):
     â”‚                                â”‚     entity = await processor
     â”‚                                â”‚                .process(event)
     â”‚                                â”‚     batch.add(entity)
     â”‚                                â”‚
     â”‚                                â”œâ†’ await stateManager
     â”‚                                â”‚       .saveBatch(batch)
     â”‚                                â”‚
     â”‚  onProgress(progress)          â”‚
     â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ eventBus.emit('progress')
     â”‚                                â”‚
     â”‚                                â”œâ†’ await sleep(interval)
     â”‚                                â”‚
     â”‚                                â””â†’ } loop continues...
     â”‚
     â”‚  stop()                        â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
     â”‚                                â”‚ await this.stopSignal
     â”‚                                â”‚ return

Benefits:
âœ… Direct method calls
âœ… Clear data flow
âœ… Easy to test (just async functions)
âœ… Better error handling
âœ… No Worker Thread complexity
```

---

## 6. DATABASE OPERATIONS - CURRENT vs PROPOSED

### CURRENT (Multiple Calls Per Event)

```
Event Processing
    â”‚
    â”œâ”€â†’ const { ddo, ddoState } = await getDatabase()
    â”‚
    â”œâ”€â†’ await ddo.retrieve(id)             â† DB call 1
    â”‚
    â”œâ”€â†’ await ddo.update(updatedDdo)       â† DB call 2
    â”‚
    â””â”€â†’ await ddoState.update(...)         â† DB call 3

For 100 events: ~300 database calls
```

### PROPOSED (Batch Operations)

```
Event Processing
    â”‚
    â”œâ”€â†’ Validate and process all events
    â”‚   (in memory, no DB calls)
    â”‚
    â””â”€â†’ await stateManager.saveBatch([
            ...ddos,
            ...orders,
            ...stateUpdates
        ])
        â”‚
        â””â”€â†’ Single transaction:
            BEGIN
              UPDATE indexer SET lastBlock = ...
              INSERT INTO ddos VALUES ...
              INSERT INTO orders VALUES ...
              UPDATE ddo_state SET ...
            COMMIT

For 100 events: ~1 database transaction
Performance improvement: 100-300x
```

---

## 7. ERROR HANDLING - CURRENT vs PROPOSED

### CURRENT (Multiple Retry Layers)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ retryCrawlerWithDelay()                 â”‚
â”‚   MAX_CRAWL_RETRIES = 10                â”‚
â”‚   â”œâ”€â†’ startCrawler()                    â”‚
â”‚   â”‚   â””â”€â†’ tryFallbackRPCs()             â”‚
â”‚   â”‚                                     â”‚
â”‚   â””â”€â†’ On failure: recursive call        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ retrieveChunkEvents()                   â”‚
â”‚   â”œâ”€â†’ provider.getLogs()                â”‚
â”‚   â””â”€â†’ On error: throw                   â”‚
â”‚       â””â”€â†’ Caught by processNetworkData  â”‚
â”‚           â””â”€â†’ chunkSize = chunkSize / 2 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ processBlocks()                         â”‚
â”‚   â””â”€â†’ On error: catch                   â”‚
â”‚       â””â”€â†’ sleep & retry same chunk      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ withRetrial()                           â”‚
â”‚   maxRetries = 5                        â”‚
â”‚   â””â”€â†’ Used in decryptDDO                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Issues:
âŒ 4 different retry mechanisms
âŒ Unclear recovery state
âŒ Potential infinite loops
âŒ No circuit breaker
```

### PROPOSED (Unified Strategy)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ResilientRpcClient               â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚     Circuit Breaker          â”‚      â”‚
â”‚  â”‚  States: CLOSED â†’ OPEN â†’ HALFâ”‚      â”‚
â”‚  â”‚  Failure threshold: 5        â”‚      â”‚
â”‚  â”‚  Timeout: 60s                â”‚      â”‚
â”‚  â”‚  Success threshold: 2        â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                               â”‚
â”‚         â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚    Retry Strategy            â”‚      â”‚
â”‚  â”‚  Max attempts: 3             â”‚      â”‚
â”‚  â”‚  Backoff: exponential        â”‚      â”‚
â”‚  â”‚  Jitter: Â±20%                â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                               â”‚
â”‚         â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚    Fallback Providers        â”‚      â”‚
â”‚  â”‚  Try each provider in order  â”‚      â”‚
â”‚  â”‚  Mark as unhealthy on error  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                               â”‚
â”‚         â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚    Metrics Collection        â”‚      â”‚
â”‚  â”‚  - Success/failure rates     â”‚      â”‚
â”‚  â”‚  - Latency per provider      â”‚      â”‚
â”‚  â”‚  - Circuit breaker state     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
âœ… Single retry mechanism
âœ… Prevents cascade failures
âœ… Clear recovery path
âœ… Observable behavior
âœ… Production-ready
```

---

## 8. TESTING STRATEGY - CURRENT vs PROPOSED

### CURRENT

```
Integration Tests (Heavy)
    â”‚
    â”œâ”€â†’ Start local blockchain (Ganache)
    â”œâ”€â†’ Deploy contracts
    â”œâ”€â†’ Start Elasticsearch/Typesense
    â”œâ”€â†’ Create OceanIndexer
    â”œâ”€â†’ Wait for worker threads to start
    â”œâ”€â†’ Publish test assets
    â”œâ”€â†’ Wait for indexing (polling)
    â”œâ”€â†’ Query database
    â””â”€â†’ Assert results

Issues:
âŒ Slow (30+ seconds per test)
âŒ Flaky (timing issues)
âŒ Hard to debug
âŒ Worker threads hard to mock
âŒ Few unit tests
```

### PROPOSED

```
Unit Tests (Fast)
    â”‚
    â”œâ”€â†’ EventExtractor
    â”‚   â””â”€â†’ Mock logs â†’ assert events
    â”‚       Time: ~10ms
    â”‚
    â”œâ”€â†’ FactoryValidator
    â”‚   â””â”€â†’ Mock contract â†’ assert validation
    â”‚       Time: ~5ms
    â”‚
    â”œâ”€â†’ MetadataCreatedHandler
    â”‚   â””â”€â†’ Mock dependencies â†’ assert DDO
    â”‚       Time: ~20ms
    â”‚
    â””â”€â†’ StateManager
        â””â”€â†’ Mock repositories â†’ assert calls
            Time: ~5ms

Integration Tests (Moderate)
    â”‚
    â”œâ”€â†’ ChainIndexer (end-to-end)
    â”‚   â””â”€â†’ Mock RPC + DB â†’ assert flow
    â”‚       Time: ~100ms
    â”‚
    â””â”€â†’ ValidationPipeline
        â””â”€â†’ Mock validators â†’ assert chain
            Time: ~50ms

Contract Tests
    â”‚
    â””â”€â†’ ResilientRpcClient
        â””â”€â†’ Real RPC providers (staging)
            Time: ~500ms

Benefits:
âœ… Fast feedback (< 1s for unit tests)
âœ… Easy to debug
âœ… High coverage
âœ… Reliable
âœ… Parallelizable
```

---

## 9. METRICS & OBSERVABILITY

### Proposed Metrics Dashboard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   INDEXER DASHBOARD                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Chain Status                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Chain  â”‚ Last Block  â”‚ Lag      â”‚ Status  â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ 1      â”‚ 12,345,678  â”‚ 10 mins  â”‚ ğŸŸ¢      â”‚         â”‚
â”‚  â”‚ 137    â”‚ 45,678,901  â”‚ 2 mins   â”‚ ğŸŸ¢      â”‚         â”‚
â”‚  â”‚ 8996   â”‚ 1,234,567   â”‚ 1 hour   â”‚ ğŸ”´      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                          â”‚
â”‚  Event Processing                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Events/sec: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 127 avg          â”‚         â”‚
â”‚  â”‚ Blocks/sec: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  45 avg          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                          â”‚
â”‚  Event Types (last hour)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ MetadataCreated:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 234             â”‚         â”‚
â”‚  â”‚ MetadataUpdated:  â–ˆâ–ˆâ–ˆ 45                   â”‚         â”‚
â”‚  â”‚ OrderStarted:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 123               â”‚         â”‚
â”‚  â”‚ OrderReused:      â–ˆâ–ˆ 34                    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                          â”‚
â”‚  RPC Health                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚Providerâ”‚ Latency  â”‚ Success â”‚ Circuit  â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚Infura  â”‚ 120ms    â”‚ 99.8%   â”‚ CLOSED   â”‚            â”‚
â”‚  â”‚Alchemy â”‚ 95ms     â”‚ 99.9%   â”‚ CLOSED   â”‚            â”‚
â”‚  â”‚Public  â”‚ 450ms    â”‚ 87.2%   â”‚ OPEN     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                          â”‚
â”‚  Database Performance                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Write Latency: 45ms avg                    â”‚         â”‚
â”‚  â”‚ Read Latency:  12ms avg                    â”‚         â”‚
â”‚  â”‚ Batch Size:    50 avg                      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                          â”‚
â”‚  Errors (last hour)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ RPC Errors:        â–ˆ 5                     â”‚         â”‚
â”‚  â”‚ Validation Errors: â–ˆâ–ˆ 12                   â”‚         â”‚
â”‚  â”‚ DB Errors:         0                       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Metrics

```typescript
// Counters
indexer_blocks_processed_total{chain="1"}
indexer_events_processed_total{chain="1", type="metadata"}
indexer_rpc_calls_total{chain="1", provider="infura", result="success"}
indexer_validation_failures_total{chain="1", validator="factory"}

// Gauges
indexer_last_indexed_block{chain="1"}
indexer_block_lag_seconds{chain="1"}
indexer_chain_status{chain="1"}  // 1=healthy, 0=unhealthy

// Histograms
indexer_block_processing_duration_seconds{chain="1"}
indexer_event_processing_duration_seconds{type="metadata"}
indexer_rpc_latency_seconds{provider="infura"}
indexer_db_write_duration_seconds

// Summaries
indexer_batch_size{operation="save_ddos"}
```

---

## 10. COMPARISON SUMMARY

| Aspect              | Current                          | Proposed                              | Improvement          |
| ------------------- | -------------------------------- | ------------------------------------- | -------------------- |
| **Architecture**    | Worker threads per chain         | Async ChainIndexer classes            | Simpler              |
| **Code Complexity** | High (nested, mixed concerns)    | Low (SRP, clear layers)               | 60% reduction        |
| **Testing**         | Integration-heavy                | Unit test friendly                    | 10x faster tests     |
| **Performance**     | Serial processing, many DB calls | Batch operations, parallel validation | 2-10x faster         |
| **Error Handling**  | Multiple retry mechanisms        | Unified circuit breaker               | More reliable        |
| **Observability**   | Logs only                        | Metrics + logs + tracing              | Production-ready     |
| **Maintainability** | Hard to modify                   | Easy to extend                        | New feature < 1 week |
| **Memory Usage**    | Thread overhead                  | Efficient async                       | 20-30% reduction     |
| **Debugging**       | Thread dumps, message tracing    | Stack traces, clear flow              | Much easier          |

---

**These diagrams should be used alongside the detailed architecture document for the meeting discussion.**
