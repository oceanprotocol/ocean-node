name: Trigger N8N Security Scan

on:
  workflow_dispatch:
    inputs:
      overrides:
        description: 'Optional JSON overrides for the n8n workflow'
        required: false
        default: '{}'

jobs:
  trigger-n8n:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare hybrid payload
        id: payload
        run: |
          echo "Building payload.json"

          cat <<EOF > payload.json
          {
            "repo": "${{ github.repository }}",
            "owner": "${{ github.repository_owner }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "actor": "${{ github.actor }}",

            "before": "${{ github.event.before || '' }}",
            "after": "${{ github.event.after || '' }}",

            "pr": ${{ github.event.pull_request.number || 'null' }},
            "headSha": "${{ github.event.pull_request.head.sha || '' }}",
            "headRef": "${{ github.event.pull_request.head.ref || '' }}",
            "baseSha": "${{ github.event.pull_request.base.sha || '' }}",
            "baseRef": "${{ github.event.pull_request.base.ref || '' }}",

            "cloneUrl": "${{ github.event.repository.clone_url || '' }}",

            "overrides": ${{ github.event.inputs.overrides }}
          }
          EOF

          echo "Payload built:"
          cat payload.json

      - name: Send payload to n8n webhook
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            https://pandoras-box.oceanprotocol.io/webhook-test/66d5c38a-7df7-4106-a8e3-f3070fcb6858
